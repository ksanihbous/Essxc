<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - <%= siteName || 'ExHub' %></title>
  <link rel="stylesheet" href="/public/css/main.css" />
  <script src="/public/js/protect.js" defer></script>
</head>
<body class="page-dark">
  <%- include('partials/nav', { active: 'dashboard' }) %>

  <main class="container">
    <section class="page-header dashboard-header">
      <div class="user-info">
        <img
          class="avatar"
          src="<%= user && user.avatar
                  ? 'https://cdn.discordapp.com/avatars/' + user.id + '/' + user.avatar + '.png'
                  : '/public/img/logo-exhub.png' %>"
          alt="avatar"
        />
        <div>
          <h1>Welcome back, <%= user.global_name || user.username %></h1>
          <p>ID: <code><%= user.id %></code></p>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <span class="stat-label">Total Keys</span>
          <span class="stat-value"><%= stats.totalKeys %></span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Active Keys</span>
          <span class="stat-value"><%= stats.activeKeys %></span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Premium Keys</span>
          <span class="stat-value"><%= stats.premiumKeys %></span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header-row">
        <h2>Your Keys</h2>
        <a href="/get-key?provider=workink" class="btn btn-small btn-primary">
          Get New Key
        </a>
      </div>

      <% if (!keys || !keys.length) { %>
        <p class="helper-text">
          You don't have any keys yet. Generate one from the Get Key tab.
        </p>
      <% } else { %>
        <table class="keys-table">
          <thead>
            <tr>
              <th>Key</th>
              <th>Provider</th>
              <th>Created</th>
              <th>Expires</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% keys.forEach(function(k) {
                 const isExpired = !k.expiresAfter || k.expiresAfter <= Date.now() || k.deleted;
                 const status = isExpired ? 'Expired' : 'Active';
            %>
              <tr>
                <td><code class="mono"><%= k.token %></code></td>
                <td><%= k.provider || '-' %></td>
                <td>
                  <%= k.createdAt
                        ? new Date(k.createdAt).toLocaleString()
                        : '-' %>
                </td>
                <td>
                  <%= k.expiresAfter
                        ? new Date(k.expiresAfter).toLocaleString()
                        : '-' %>
                </td>
                <td>
                  <span class="status-pill <%= status === 'Active'
                                                ? 'status-working'
                                                : 'status-maint' %>">
                    <%= status %>
                  </span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </section>
  </main>

  <footer class="footer">
    <span>
      Dashboard connected to Discord account:
      <strong><%= user.username %></strong>
    </span>
  </footer>
</body>
</html>
