<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Get Key - <%= siteName %></title>
  <link rel="stylesheet" href="/public/css/main.css" />
  <script src="/public/js/protect.js" defer></script>
</head>
<body class="page-dark">
<%- include('partials/nav', { active: 'get-key' }) %>

<main class="container">
  <section class="page-header">
    <h1>Complete Verification</h1>
    <p>Complete a quick verification with <span class="accent"><%= provider %></span> to get your key and start using our scripts.</p>
  </section>

  <section class="grid-2">
    <div class="card">
      <div class="card-header-row">
        <h2>Verification</h2>
        <span class="badge">HWID Locked</span>
      </div>

      <p class="helper-text">
        Keys are bound to your Discord account and hardware. Default lifetime:
        <strong><%= keyTtlHours %>h</strong>.
      </p>

      <form method="post" action="/get-key/start?provider=<%= provider %>">
        <button type="submit" class="btn btn-primary btn-full">
          Start verification with <%= provider === 'linkvertise' ? 'Linkvertise' : 'Work.ink' %>
        </button>
      </form>

      <% if (newKeyToken) { %>
        <div class="alert alert-success">
          <strong>New Key Generated:</strong>
          <code><%= newKeyToken %></code>
          <p>Copy this key into your Roblox loader UI.</p>
        </div>
      <% } %>
    </div>

    <div class="card">
      <div class="card-header-row">
        <h2>Your Keys</h2>
        <span class="badge badge-soft">
          <%= keys.length %> total
        </span>
      </div>

      <% if (!keys.length) { %>
        <p class="helper-text">No keys yet. Complete a verification to generate your first key.</p>
      <% } else { %>
        <table class="keys-table">
          <thead>
          <tr>
            <th>Key</th>
            <th>Provider</th>
            <th>Time Left</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody>
          <% keys.forEach(function(k) { 
               const leftMs = (k.expiresAfter || 0) - Date.now();
               const leftSec = Math.max(0, Math.floor(leftMs / 1000));
               const hours = Math.floor(leftSec / 3600);
               const mins = Math.floor((leftSec % 3600) / 60);
               const status = (k.deleted || k.expiresAfter <= Date.now()) ? 'Expired' : 'Active';
          %>
            <tr>
              <td><code class="mono"><%= k.token %></code></td>
              <td><%= k.provider || '-' %></td>
              <td>
                <% if (status === 'Expired') { %>
                  00:00
                <% } else { %>
                  <%= hours.toString().padStart(2,'0') %>:<%= mins.toString().padStart(2,'0') %>
                <% } %>
              </td>
              <td>
                <span class="status-pill <%= status === 'Active' ? 'status-working' : 'status-maint' %>">
                  <%= status %>
                </span>
              </td>
            </tr>
          <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </section>
</main>

<footer class="footer">
  <span>Need help? Join our Discord.</span>
</footer>
</body>
</html>
